var TWiC=function(t){return t.ShadeBlend=function(t,i,e){var s=0>t?-1*t:t,o=Math.round,r=parseInt;if(i.length>7){var n=i.split(","),l=(e?e:0>t?"rgb(0,0,0)":"rgb(255,255,255)").split(","),c=r(n[0].slice(4)),h=r(n[1]),a=r(n[2]);return"rgb("+(o((r(l[0].slice(4))-c)*s)+c)+","+(o((r(l[1])-h)*s)+h)+","+(o((r(l[2])-a)*s)+a)+")"}var n=r(i.slice(1),16),l=r((e?e:0>t?"#000000":"#FFFFFF").slice(1),16),p=n>>16,_=n>>8&255,m=255&n;return"#"+(16777216+65536*(o(((l>>16)-p)*s)+p)+256*(o(((l>>8&255)-_)*s)+_)+(o(((255&l)-m)*s)+m)).toString(16).slice(1)},t.DataShape=function(t,i,e,s,o){this.m_coordinates=t,this.m_size=i,this.m_name=e,this.m_level=s,this.m_panel=o},t.DataShape.method("BindDataToNode",function(){}),t.DataShape.method("AppendSVGandBindData",function(){}),t.ClusterCircle=function(i,e,s,o,r,n,l,c,h){t.DataShape.apply(this,arguments),this.m_numberCircles=l,this.m_ideal_text=h,this.m_topTopics=[];for(var a=0;a<this.m_numberCircles;a++)this.m_topTopics.push([c[a][0],c[a][1]]);this.m_clusterGroup=null,this.m_linkedViews=n},t.ClusterCircle.inherits(t.DataShape),t.ClusterCircle.prototype.s_colorHighlight=.5,t.ClusterCircle.prototype.s_colorLolight=-.5,t.ClusterCircle.prototype.s_unhighlightedOpacity=.3,t.ClusterCircle.method("Load",function(){}),t.ClusterCircle.method("BindDataToNode",function(t){t.center=[this.m_coordinates.x,this.m_coordinates.y],t.radius=this.m_size,t.parentDims=[parseInt(this.m_panel.m_svg.attr("width")),parseInt(this.m_panel.m_svg.attr("height"))]}),t.ClusterCircle.method("AppendSVGandBindData",function(i){var e=this.m_size,s=this.m_size/this.m_numberCircles;this.m_clusterGroup=i.append("g").attr("class","group_twic_datashape_smoothzooming").attr("id","twic_clustercircle_"+this.m_level.m_objectCount).on("mouseout",function(){}.bind(this)),this.m_level.m_objectCount+=1;for(var o=0;o<this.m_numberCircles;o++){var r=null;r=1==this.m_numberCircles?{color:this.m_level.m_topicColors[this.m_topTopics[o][0]],hicolor:this.m_level.m_topicColors[this.m_topTopics[o][0]],locolor:this.m_level.m_topicColors[this.m_topTopics[o][0]],topicID:this.m_topTopics[o][0],prop:this.m_topTopics[o][1]}:{color:this.m_level.m_topicColors[this.m_topTopics[o][0]],hicolor:t.ShadeBlend(TWiC.ClusterCircle.prototype.s_colorHighlight,this.m_level.m_topicColors[this.m_topTopics[o][0]]),locolor:t.ShadeBlend(TWiC.ClusterCircle.prototype.s_colorLolight,this.m_level.m_topicColors[this.m_topTopics[o][0]]),topicID:this.m_topTopics[o][0],prop:this.m_topTopics[o][1]},this.m_clusterGroup.append("circle").datum(r).attr("class","topic_circle").attr("id",function(t){return"topic-"+t.topicID}).attr("cx",this.m_coordinates.x).attr("cy",this.m_coordinates.y).attr("r",e).style("fill",function(t){return t.locolor}).style("opacity",TWiC.ClusterCircle.prototype.s_unhighlightedOpacity).on("mouseover",function(t){this.m_panel.Update(t);for(var i=0;i<this.m_panel.m_linkedViews.length;i++)this.m_panel.m_linkedViews[i].Update(t)}.bind(this)).on("mouseout",function(){this.m_panel.Update(null);for(var t=0;t<this.m_panel.m_linkedViews.length;t++)this.m_panel.m_linkedViews[t].Update(null)}.bind(this)).on("click",function(t){this.m_panel.Update(t);for(var i=0;i<this.m_panel.m_linkedViews.length;i++)this.m_panel.m_linkedViews[i].Update(t)}.bind(this)),e-=s}}),t.ClusterCircle.method("HighlightCluster",function(t){this.m_clusterGroup.selectAll(".topic_circle").filter(function(i){return t==i.topicID}).style("fill",function(t){return t.color}).style("opacity",1),this.m_clusterGroup.selectAll(".topic_circle").filter(function(i){return t!=i.topicID}).style("fill",function(t){return t.locolor}).style("opacity",TWiC.ClusterCircle.prototype.s_unhighlightedOpacity)}),t.ClusterCircle.method("DarkenCluster",function(){this.m_clusterGroup.selectAll(".topic_circle").style("fill",function(t){return t.locolor}).style("opacity",TWiC.ClusterCircle.prototype.s_unhighlightedOpacity)}),t.ClusterCircle.method("HighlightTopicShapes",function(t){var i=this.m_panel.m_svg.selectAll(".topic_circle").filter(function(i){return i.topicID==t.topicID}).style("fill",t.color);this.m_panel.m_svg.selectAll(".topic_circle").filter(function(i){return i.topicID!=t.topicID}).style("fill",function(t){return t.locolor}).style("opacity",TWiC.ClusterCircle.prototype.s_unhighlightedOpacity),i.each(function(){d3.select(this.parentNode).selectAll(".topic_circle").style("opacity",1)})}),t.TextRectangle=function(){},t.TextRectangle.inherits(t.DataShape),t}(TWiC||{}),TWiC=function(t){return t.Level=function(){this.m_queue=new queue,this.m_corpusMap={},this.m_corpusInfo={},this.m_topicWordLists={},this.m_topicColors={},this.m_objectCount=0,this.m_graphViews=null,this.m_infoViews=null,this.m_levelDiv=null},t.Level.prototype.s_twicLevels=[],t.Level.prototype.Instance=function(){var i=new t.Level;return t.Level.prototype.s_twicLevels.push(i),i},t.Level.method("LoadJSON",function(t,i){var e=null;this.m_queue.defer(function(i){d3.json(t,function(t,s){e=s,this.m_corpusInfo=e,this.m_topicWordLists=e.topic_info[0],this.m_topicColors=e.topic_info[1],i(null,e)}.bind(this))}.bind(this));var s=null;this.m_queue.defer(function(t){d3.json(i,function(i,e){s=e,this.m_corpusMap=s,t(null,s)}.bind(this))}.bind(this))}),t.Level.method("Initialize",function(t,i,e,s,o){this.m_coordinates=t,this.m_size=i,this.m_name=e,this.m_graphViews=s,this.m_infoViews=o,this.m_levelDiv=d3.select("body").append("div").attr("class","div_twic_level").attr("id","twic_level_"+this.m_name).style("position","relative").style("left",this.m_coordinates.x).style("top",this.m_coordinates.y).style("max-width",this.m_size.width).style("max-height",this.m_size.height);for(var r=0;r<this.m_graphViews.length;r++)this.m_graphViews[r].Initialize(this.m_levelDiv);for(var r=0;r<this.m_infoViews.length;r++)this.m_infoViews[r].Initialize(this.m_levelDiv)}),t.Level.method("Start",function(){for(var t=0;t<this.m_graphViews.length;t++)this.m_graphViews[t].Start();for(var t=0;t<this.m_infoViews.length;t++)this.m_infoViews[t].Start()}),t.GetViewport=function(){var t=window,i="inner";return"innerWidth"in window||(i="client",t=document.documentElement||document.body),{width:t[i+"Width"],height:t[i+"Height"]}},t}(TWiC||{}),TWiC=function(t){return t.Panel=function(t,i,e,s,o){this.m_coordinates=t,this.m_size=i,this.m_name=e,this.m_level=s,this.m_div=null,this.m_svg=null,this.m_groupOverlay=null,this.m_linkedViews=o},t.Panel.method("Initialize",function(){}),t.Panel.method("Start",function(){}),t.Panel.method("Update",function(){}),t.GraphView=function(){t.Panel.apply(this,arguments)},t.GraphView.inherits(t.Panel),t.GraphView.prototype.Collide=function(t){var i=16,e=t.radius+i,s=t.x-e,o=t.x+e,r=t.y-e,n=t.y+e;return function(i,e,l,c,h){if(i.point&&i.point!==t){var a=t.x-i.point.x,p=t.y-i.point.y,_=Math.sqrt(a*a+p*p),m=t.radius+i.point.radius;m>_&&(_=(_-m)/_*.5,t.x-=a*=_,t.y-=p*=_,i.point.x+=a,i.point.y+=p)}return e>o||s>c||l>n||r>h}},t.CorpusView=function(){t.GraphView.apply(this,arguments)},t.CorpusView.inherits(t.GraphView),t.CorpusClusterView=function(){t.GraphView.apply(this,arguments),this.m_twicObjects=[],this.m_objectsJSON=[],this.m_nodes=[],this.m_links=[],this.m_graph=null,this.m_idealText=this.m_level.m_corpusMap.ideal_text,this.b_positionsCalculated=!1,this.m_rootIndex=-1,this.m_zoomBehavior=d3.behavior.zoom()},t.CorpusClusterView.inherits(t.GraphView),t.CorpusClusterView.method("Initialize",function(t){this.m_div=t.append("div").attr("class","div_twic_graph_corpusclusterview div_twic_graph twic_panel").attr("id","div_twic_graph_corpusclusterview_"+this.m_name).style("left",this.m_coordinates.x).style("top",this.m_coordinates.y).style("max-width",this.m_size.width).style("max-height",this.m_size.height),this.m_svg=this.m_div.append("svg").attr("class","svg_twic_graph").attr("id","svg_twic_graph_corpusclusterview_"+this.m_name).attr("x",this.m_coordinates.x).attr("y",this.m_coordinates.y).attr("width",this.m_size.width).attr("height",this.m_size.height),this.m_groupOverlay=this.m_svg.append("g").attr("class","group_twic_graph_overlay").attr("id","group_twic_graph_overlay_"+this.m_name).call(this.m_zoomBehavior.scaleExtent(TWiC.CorpusClusterView.prototype.s_scaleExtentLimits).on("zoom",this.ScrollToZoom(this))).append("rect").attr("class","rect_twic_graph").attr("id","rect_twic_graph_"+this.m_name).attr("x",this.m_coordinates.x).attr("y",this.m_coordinates.y).attr("rx",this.m_div.attr("border-radius")).attr("ry",this.m_div.attr("border-radius")).attr("width",this.m_size.width).attr("height",this.m_size.height);for(var i=0,e=0;e<this.m_level.m_corpusMap.children.length;e++)i+=this.m_level.m_corpusMap.children[e].distance2ideal;i/=this.m_level.m_corpusMap.children.length;for(var s=80,e=0;e<this.m_level.m_corpusMap.children.length;e++){var o=new TWiC.ClusterCircle([0,0],20,e,this.m_level,this,this.m_linkedViews,10,this.m_level.m_corpusMap.children[e].topics,this.m_level.m_corpusMap.children[e].ideal_text);this.m_objectsJSON.push({name:this.m_level.m_corpusMap.children[e].name,ideal_text:this.m_level.m_corpusMap.children[e].ideal_text,distance2ideal:2+Math.abs((this.m_level.m_corpusMap.children[e].distance2ideal-i)*s),topics:this.m_level.m_corpusMap.children[e].topics,children:[]}),this.m_twicObjects.push(o)}for(var r=0,e=0;e<this.m_objectsJSON.length;e++)this.m_idealText==this.m_objectsJSON[e].ideal_text&&(this.m_nodes.push({index:e}),r=e,this.m_rootIndex=r);var n=!1;if(0==this.m_nodes.length){n=!0,r=this.m_twicObjects.length,this.m_rootIndex=r,this.m_nodes.push({index:r});for(var l=[],c=10,e=0;c>e;e++)l.push([]);for(var h in this.m_level.m_corpusMap.topics)this.m_level.m_corpusMap.topics[h][0]<c+1&&(l[this.m_level.m_corpusMap.topics[h][0]-1]=this.m_level.m_corpusMap.topics[h]);this.m_twicObjects.push(new TWiC.ClusterCircle([0,0],20,r,this.m_level,this,this.m_linkedViews,c,l,this.m_level.m_corpusMap.ideal_text))}for(var e=0;e<this.m_objectsJSON.length;e++)r!=e&&(this.m_nodes.push({index:e}),this.m_links.push({source:e,target:r,value:this.m_objectsJSON[e].distance2ideal}));this.m_graph=d3.layout.force().nodes(this.m_nodes).links(this.m_links).size([this.m_size.width,this.m_size.height]).charge(.2).gravity(0).linkDistance(function(t){return t.value*TWiC.CorpusClusterView.prototype.s_linkDistanceMod})}),t.CorpusClusterView.method("Start",function(){this.m_svg.selectAll(".link").data(this.m_links).enter().append("line").attr("class","link").style("stroke-width",function(t){return Math.sqrt(t.value)}).style("stroke","black");for(index=0;index<this.m_twicObjects.length;index++)for(var t=0;t<this.m_nodes.length;t++)if(this.m_twicObjects[index].m_name==this.m_nodes[t].index){this.m_twicObjects[index].BindDataToNode(this.m_nodes[t]);break}this.m_svg.selectAll(".node").data(this.m_nodes).enter().append("g").attr("class","node").attr("id",function(t){return"node_"+t.index});for(index=0;index<this.m_twicObjects.length;index++)for(var t=0;t<this.m_nodes.length;t++)this.m_twicObjects[index].m_name==this.m_nodes[t].index&&this.m_twicObjects[index].AppendSVGandBindData(this.m_svg.select(".node#node_"+t));setTimeout(function(){this.m_graph.start();for(var t=1e3;t>0;--t)this.Tick();this.m_graph.stop(),this.b_positionsCalculated=!0}.bind(this),10)}),t.CorpusClusterView.method("ScrollToZoom",function(t){var i=function(){d3.select("#twic_level_"+t.m_name).attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")};return i}),t.CorpusClusterView.method("Tick",function(){var i=this.m_svg.selectAll(".link"),e=this.m_svg.selectAll(".node"),s=parseInt(this.m_svg.attr("width")),o=parseInt(this.m_svg.attr("height"));if(this.m_nodes[this.m_rootIndex].x=s>>1,this.m_nodes[this.m_rootIndex].y=o>>1,this.b_positionsCalculated)i.attr("x1",function(t){return t.source.firstX}).attr("y1",function(t){return t.source.firstY}).attr("x2",function(t){return t.target.firstX}).attr("y2",function(t){return t.target.firstY}),e.attr("transform",function(t){return"translate("+t.firstX+","+t.firstY+")"});else{e.attr("cx",function(t){return t.x=Math.max(t.radius,Math.min(s-t.radius,t.x))}).attr("cy",function(t){return t.y=Math.max(t.radius,Math.min(o-t.radius,t.y))});for(var r=d3.geom.quadtree(this.m_nodes),n=0,l=this.m_nodes.length;++n<l;)r.visit(t.GraphView.prototype.Collide(this.m_nodes[n]));i.attr("x1",function(t){return t.source.firstX=t.source.x,t.source.x}).attr("y1",function(t){return t.source.firstY=t.source.y,t.source.y}).attr("x2",function(t){return t.target.firstX=t.target.x,t.target.x}).attr("y2",function(t){return t.target.firstY=t.target.y,t.target.y}),e.attr("transform",function(t){return t.firstX=t.x,t.firstY=t.y,"translate("+t.x+","+t.y+")"})}}),t.CorpusClusterView.method("Update",function(t){null!=t?this.HighlightAllClustersWithTopic(t):this.DarkenAllClusters()}),t.CorpusClusterView.method("DarkenAllClusters",function(){this.m_svg.selectAll(".topic_circle").style("fill",function(t){return t.locolor}).style("opacity",TWiC.ClusterCircle.prototype.s_unhighlightedOpacity)}),t.CorpusClusterView.method("HighlightAllClustersWithTopic",function(t){var i=this.m_svg.selectAll(".topic_circle").filter(function(i){return i.topicID==t.topicID}).style("fill",t.color);this.m_svg.selectAll(".topic_circle").filter(function(i){return i.topicID!=t.topicID}).style("fill",function(t){return t.locolor}).style("opacity",TWiC.ClusterCircle.prototype.s_unhighlightedOpacity),i.each(function(){d3.select(this.parentNode).selectAll(".topic_circle").style("opacity",1)})}),t.CorpusClusterView.prototype.s_linkDistanceMod=100,t.CorpusClusterView.prototype.s_scaleExtentLimits=[1,16],t.TextClusterView=function(){t.GraphView.apply(this,arguments)},t.TextClusterView.inherits(t.GraphView),t.TextView=function(){t.GraphView.apply(this,arguments)},t.TextView.inherits(t.GraphView),t.InformationView=function(){t.Panel.apply(this,arguments)},t.InformationView.inherits(t.Panel),t.TopicBar=function(){t.InformationView.apply(this,arguments)},t.TopicBar.inherits(t.InformationView),t.TopicBar.method("Initialize",function(i){this.m_currentSelection=-1,this.m_div=i.append("div").attr("class","div_twic_info_topicbar div_twic_info twic_panel").attr("id","div_twic_info_topicbar_"+this.m_name).style("left",this.m_coordinates.x).style("top",this.m_coordinates.y).style("max-width",this.m_size.width).style("max-height",this.m_size.height),this.m_svg=this.m_div.append("svg").attr("class","svg_twic_info").attr("id","svg_twic_info_topicbar_"+this.m_name).attr("x",this.m_coordinates.x).attr("y",this.m_coordinates.y).attr("width",this.m_size.width).attr("height",this.m_size.height).attr("viewBox","0 "+t.TopicBar.prototype.s_textInfo.yIncrement+" "+t.TopicBar.prototype.s_svgSize.width+" "+t.TopicBar.prototype.s_svgSize.height);for(var e,s=this.m_svg.append("g").attr("class","group_twic_topicbar"),o=[],r=0;r<this.m_level.m_topicWordLists.length;r++){e="Topic "+r.toString()+": ";for(var n=0;n<this.m_level.m_topicWordLists[r].length;n++)e+=this.m_level.m_topicWordLists[r][n]+" ";o.push(e.trim())}for(var l=0,c=0,h=t.TopicBar.prototype.s_textInfo.yStart+t.TopicBar.prototype.s_textInfo.fontSize;c<o.length;c++){var a=s.append("rect").attr("class","topic_highlightrect").attr("id","topic_"+c).attr("fill",this.m_level.m_topicColors[c]),p=s.append("text").attr("class","topic_wordlist").attr("id","topic_"+c).datum({id:c.toString()}).attr("x","0").attr("y",h).attr("dx","0").attr("dy","0").attr("fill",this.m_level.m_topicColors[c]).on("click",function(t){update_data={topicID:t.id,color:this.m_level.m_topicColors[t.id]},this.HighlightText(update_data);for(var i=0;i<this.m_linkedViews.length;i++)this.m_linkedViews[i].Update(update_data)}.bind(this)),_=textFlow(o[c],p[0][0],t.TopicBar.prototype.s_svgSize.width,p.style("font-size"),t.TopicBar.prototype.s_textInfo.yIncrement,!1);a.datum({dy:l+_}).attr("x",p.attr("x")).attr("y",parseInt(p.attr("y"))-parseInt(p.style("font-size"))).attr("width",t.TopicBar.prototype.s_svgSize.width).attr("height",_).attr("opacity",0),h+=_,l+=_}this.m_svg.attr("height",l)}),t.TopicBar.method("HighlightText",function(t){-1!=this.m_currentSelection&&(d3.select(".topic_wordlist#topic_"+this.m_currentSelection).attr("fill",function(){return this.m_level.m_topicColors[this.m_currentSelection]}.bind(this)),d3.select(".topic_highlightrect#topic_"+this.m_currentSelection).attr("fill",this.m_div.style("background-color")).attr("opacity","0")),d3.select(".topic_wordlist#topic_"+t.topicID).attr("fill",this.m_div.style("background-color")),d3.select(".topic_highlightrect#topic_"+t.topicID).attr("fill",t.color).attr("opacity","1"),this.m_currentSelection=t.topicID}),t.TopicBar.method("Update",function(i){null!=i?(d3.select(".topic_wordlist#topic_"+i.topicID).attr("fill",this.m_div.style("background-color")),d3.select(".topic_highlightrect#topic_"+i.topicID).attr("fill",i.color).attr("opacity","1"),dy=d3.select(".topic_highlightrect#topic_"+i.topicID).datum().dy,d3.select(".svg_twic_info").attr("viewBox","0 "+dy+" "+t.TopicBar.prototype.s_svgSize.width+" "+t.TopicBar.prototype.s_svgSize.height),this.m_currentSelection=i.topicID):(d3.selectAll(".topic_wordlist").attr("fill",function(t){return this.m_level.m_topicColors[t.id]}.bind(this)),d3.selectAll(".topic_highlightrect").attr("fill",this.m_div.style("background-color")).attr("opacity","0"),d3.select(".svg_twic_info").attr("viewBox","0 "+t.TopicBar.prototype.s_textInfo.yIncrement+" "+t.TopicBar.prototype.s_svgSize.width+" "+t.TopicBar.prototype.s_svgSize.height),this.m_currentSelection=-1)}),t.TopicBar.prototype.s_svgSize={width:1280,height:165},t.TopicBar.prototype.s_textInfo={yStart:-1405,yIncrement:30,fontSize:20},t.DocumentBar=function(){t.InformationView.apply(this,arguments)},t.DocumentBar.inherits(t.InformationView),t.DocumentBar.method("Initialize",function(t){this.m_div=t.append("div").attr("class","div_twic_info_docbar div_twic_info twic_panel").attr("id","div_twic_info_docbar"+this.m_name).style("left",this.m_coordinates.x).style("top",this.m_coordinates.y).style("max-width",this.m_size.width).style("max-height",this.m_size.height),this.m_svg=this.m_div.append("svg").attr("class","svg_twic_info").attr("id","svg_twic_info_docbar_"+this.m_name).attr("x",this.m_coordinates.x).attr("y",this.m_coordinates.y).attr("width",this.m_size.width).attr("height",this.m_size.height)}),t.DocumentBar.prototype.s_svgSize={width:600,height:600},t}(TWiC||{});